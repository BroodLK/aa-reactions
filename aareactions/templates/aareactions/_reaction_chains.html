<!-- file: aareactions/templates/aareactions/_reaction_chains.html -->
{% load humanize %}
<style>
  .chain-flow-row{display:flex;gap:1rem;overflow-x:auto;padding:0.75rem 0;align-items:stretch}
  .chain-flow-card{min-width:360px;max-width:360px;flex:0 0 360px}
  .chain-arrow{display:flex;align-items:center;justify-content:center;min-width:56px;flex:0 0 56px}
  .chain-arrow .shaft{position:relative;width:48px;height:28px}
  .chain-arrow .shaft::before{content:"";position:absolute;top:50%;left:0;right:10px;height:4px;transform:translateY(-50%);background:var(--bs-primary)}
  .chain-arrow .shaft::after{content:"";position:absolute;top:50%;right:0;transform:translateY(-50%);border:10px solid transparent;border-left-color:var(--bs-primary)}
</style>
{% if groups %}
  {% for end_name, bundle in groups %}
    <div class="d-flex align-items-center justify-content-between mt-4 mb-2">
      <div class="d-flex align-items-center gap-2">
        <span class="fw-semibold">{{ end_name }}</span>
      </div>
    </div>
    {% for chain in bundle %}
      <div class="chain-flow-row">
        {% for step in chain.steps %}
          <div class="card shadow-sm chain-flow-card">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-center justify-content-between">
                <span class="fw-semibold">
                  {% if step.kind == "refine" %}Refining{% else %}Reaction{% endif %}: {{ step.title }}
                </span>
                {% if step.runs %}<span class="badge text-bg-secondary">{{ step.runs|floatformat:2 }} runs</span>{% endif %}
              </div>
              {% if step.inputs %}
              <div class="small text-muted mt-2">Inputs</div>
              <ul class="small mb-2">
                {% for i in step.inputs %}
                <li>
                  {{ i.name }} ({{ i.need_per_run|floatformat:2 }})
                  <ul>
                    {% if i.produced %}
                    <li>Produced: <span class="text-warning">{{ i.total_need|floatformat:0|intcomma }}</span></li>
                    {% else %}
                      {% if i.have > 0 %}
                      <li>Have: <span class="text-success">{{ i.have|floatformat:0|intcomma }}</span> ({{ i.have_value|floatformat:2|intcomma }} ISK)</li>
                      {% endif %}
                      {% if i.need_missing > 0 %}
                      <li>Need: <span class="text-danger">{{ i.need_missing|floatformat:0|intcomma }}</span> ({{ i.need_value|floatformat:2|intcomma }} ISK)</li>
                      {% endif %}
                    {% endif %}
                    <li>Unit Price: {{ i.unit_price|floatformat:2|intcomma }} ISK</li>
                    <li>m3 / run: {{ i.m3_per_run|floatformat:2 }}</li>
                    <li>m3 total: {{ i.m3_total|floatformat:2 }}</li>
                  </ul>
                </li>
                {% endfor %}
              </ul>
              {% endif %}
              <div class="small text-muted">Produces</div>
              <ul class="small mb-2">
                <li>{{ step.product_name }} Ã— {{ step.produced_qty|floatformat:0|intcomma }}</li>
                <li>Unit Price: {% if step.produced_qty %}{% widthratio step.produced_value step.produced_qty 1 %}{% else %}0{% endif %} ISK</li>
                <li>Total Volume: {{ step.produced_volume|floatformat:2 }} m3</li>
              </ul>
              <div class="small text-muted">Value</div>
              <ul class="small mb-0">
                <li>Have: {{ step.value_have|floatformat:2|intcomma }} ISK</li>
                <li>Need: {{ step.value_need|floatformat:2|intcomma }} ISK</li>
                <li>Taxes and Fees: {{ step.fees.broker|add:step.fees.sales_tax|floatformat:2|intcomma }} ISK</li>
                <li>Produced Value: {{ step.produced_value|floatformat:2|intcomma }} ISK</li>
                <li>Increase:
                  {% with neg_have=step.value_have|floatformat:"6"|cut:"," %}
                  {% with neg_need=step.value_need|floatformat:"6"|cut:"," %}
                  {% with inc_temp=step.produced_value|floatformat:"6"|cut:"," %}
                    {% comment %} emulate produced - have - need using widthratio tricks {% endcomment %}
                    {% with have_pct=0 %}
                      {% widthratio neg_have -1 1 as have_neg %}
                      {% widthratio neg_need -1 1 as need_neg %}
                      {% with inc=inc_temp|add:have_neg|add:need_neg total=step.value_have|add:step.value_need %}
                        {{ inc|floatformat:2|intcomma }}
                        {% if total > 0 %}(<span class="text-secondary">{% widthratio inc 100 total %}%</span>){% endif %}
                      {% endwith %}
                    {% endwith %}
                  {% endwith %}
                  {% endwith %}
                  {% endwith %}
                </li>
                <li>Profit:
                  {% with prof=step.cumulative_profit %}
                    {% if prof > 0 %}
                    <span class="text-success">{{ prof|floatformat:2|intcomma }}</span>
                    {% elif prof < 0 %}
                    <span class="text-danger">{{ prof|floatformat:2|intcomma }}</span>
                    {% else %}
                    <span class="text-secondary">{{ prof|floatformat:2|intcomma }}</span>
                    {% endif %}
                  {% endwith %}
                </li>
              </ul>
            </div>
          </div>
          {% if not forloop.last %}
            <div class="chain-arrow"><div class="shaft"></div></div>
          {% endif %}
        {% endfor %}
        <div class="card shadow-sm chain-flow-card">
          <div class="card-body d-flex flex-column">
            <div class="d-flex align-items-center justify-content-between">
              <span class="fw-semibold">Final Totals</span>
              <span class="badge text-bg-secondary">{{ chain.total_runs|floatformat:2 }} runs</span>
            </div>
            <div class="small text-muted mt-2">End Product</div>
            <ul class="small mb-2">
              <li>{{ chain.end_product_name }}</li>
            </ul>
            <div class="small text-muted">Value</div>
            <ul class="small mb-0">
              <li>Final Value: {{ chain.final_value|floatformat:2|intcomma }} ISK</li>
              <li>Total Fees: {{ chain.final_fees|floatformat:2|intcomma }} ISK</li>
              <li>Total Cost: {{ chain.final_cost|floatformat:2|intcomma }} ISK</li>
              <li>Profit:
                {% if chain.final_profit > 0 %}
                <span class="text-success">{{ chain.final_profit|floatformat:2|intcomma }}</span>
                {% elif chain.final_profit < 0 %}
                <span class="text-danger">{{ chain.final_profit|floatformat:2|intcomma }}</span>
                {% else %}
                <span class="text-secondary">{{ chain.final_profit|floatformat:2|intcomma }}</span>
                {% endif %}
              </li>
              <li>ROI: {{ chain.final_roi|floatformat:2 }}%</li>
            </ul>
          </div>
        </div>
      </div>
    {% endfor %}
  {% endfor %}
{% endif %}
